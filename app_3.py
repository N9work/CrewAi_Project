from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from crewai import Agent, Crew, Task, Process 
from crewai_tools import SerperDevTool
import markdown
import os

# ตั้งค่า API Key ของ SerperDevTool (Search Tool)
search_tools = SerperDevTool(api_key=os.getenv("SERPER_API_KEY"))

app = FastAPI()

# ✅ อนุญาตให้ Frontend เรียก API ได้
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  
    allow_credentials=True,
    allow_methods=["*"],  
    allow_headers=["*"],
)

# ----------- Model สำหรับรับ Request -----------
class TaskRequest(BaseModel):
    task_type: str   # จังหวัดที่เลือก
    style: str       # สไตล์การเที่ยว
    cost: str        # ช่วงงบประมาณ (Low, Mid, High, Any)
    day: str         # จำนวนวันที่ต้องการไป
    adults: str      # จำนวนคน
    Rq: str          # ความต้องการพิเศษจากผู้ใช้ (ถ้ามี)

# ----------- การกำหนด Task Mapping แต่ละจังหวัด -----------
# เพิ่ม/แก้ไขข้อมูลให้สอดคล้องกับคำขอ
task_mapping = {
    "Phatthalung": {
        "description": (
            "คุณมีหน้าที่ในการเขียนรายงานแพ็กเกจท่องเที่ยวจังหวัดพัทลุง "
            "โดยจะต้องรีวิวข้อมูลที่ได้รับจากนักวิจัย (Researcher) และขยายความให้ละเอียด "
            "จัดทำแพ็กเกจแบบ 5 แพ็กเกจพร้อมไทม์ไลน์กิจกรรมในแต่ละวัน รวมถึงคำนวณงบประมาณ "
            "และแนะนำตัวเลือกที่พักให้ครบถ้วน"
        ),
        "expected_output": (
            "เขียน 5 แพ็กเกจเที่ยวพัทลุงพร้อมกำหนดการแต่ละวัน "
            "บอกรายละเอียดทุกอย่างตามข้อมูลที่ Researcher หาได้ "
            "แสดงราคาคร่าว ๆ รวมไปถึงระบุชื่อที่พักที่แนะนำ"
        ),
        "goal": (
            "ค้นคว้าหาสถานที่ท่องเที่ยวและข้อมูลที่ทันสมัย (ปี 2024-2025) "
            "ในจังหวัดพัทลุง ประเทศไทย "
        ),
        "person": "จำนวนคนร่วมทริป: {adults} คน\n",
        "rq": "ความต้องการเพิ่มเติม: {Rq}\n",
        "pv": "จุดหมายปลายทาง: พัทลุง, ประเทศไทย\n"
    },
    "Trang": {
        "description": (
            "คุณมีหน้าที่ในการเขียนรายงานแพ็กเกจท่องเที่ยวจังหวัดตรัง "
            "โดยจะต้องรีวิวข้อมูลที่ได้รับจากนักวิจัย (Researcher) และขยายความให้ละเอียด "
            "จัดทำแพ็กเกจแบบ 5 แพ็กเกจพร้อมไทม์ไลน์กิจกรรมในแต่ละวัน รวมถึงคำนวณงบประมาณ "
            "และแนะนำตัวเลือกที่พักให้ครบถ้วน"
        ),
        "expected_output": (
            "เขียน 5 แพ็กเกจเที่ยวตรังพร้อมกำหนดการแต่ละวัน "
            "บอกรายละเอียดทุกอย่างตามข้อมูลที่ Researcher หาได้ "
            "แสดงราคาคร่าว ๆ รวมไปถึงระบุชื่อที่พักที่แนะนำ"
        ),
        "goal": (
            "ค้นคว้าหาสถานที่ท่องเที่ยวและข้อมูลที่ทันสมัย (ปี 2024-2025) "
            "ในจังหวัดตรัง ประเทศไทย "
        ),
        "person": "จำนวนคนร่วมทริป: {adults} คน\n",
        "rq": "ความต้องการเพิ่มเติม: {Rq}\n",
        "pv": "จุดหมายปลายทาง: ตรัง, ประเทศไทย\n"
    },
    "Satun": {
        "description": (
            "คุณมีหน้าที่ในการเขียนรายงานแพ็กเกจท่องเที่ยวจังหวัดสตูล "
            "โดยจะต้องรีวิวข้อมูลที่ได้รับจากนักวิจัย (Researcher) และขยายความให้ละเอียด "
            "จัดทำแพ็กเกจแบบ 5 แพ็กเกจพร้อมไทม์ไลน์กิจกรรมในแต่ละวัน รวมถึงคำนวณงบประมาณ "
            "และแนะนำตัวเลือกที่พักให้ครบถ้วน"
        ),
        "expected_output": (
            "เขียน 5 แพ็กเกจเที่ยวสตูลพร้อมกำหนดการแต่ละวัน "
            "บอกรายละเอียดทุกอย่างตามข้อมูลที่ Researcher หาได้ "
            "แสดงราคาคร่าว ๆ รวมไปถึงระบุชื่อที่พักที่แนะนำ"
        ),
        "goal": (
            "ค้นคว้าหาสถานที่ท่องเที่ยวและข้อมูลที่ทันสมัย (ปี 2024-2025) "
            "ในจังหวัดสตูล ประเทศไทย "
            "รวมสถานที่ท่องเที่ยวอื่นๆด้วยที่ไม่ใช่แค่เกาะหลีเป๊ะ"
        ),
        "person": "จำนวนคนร่วมทริป: {adults} คน\n",
        "rq": "ความต้องการเพิ่มเติม: {Rq}\n",
        "pv": "จุดหมายปลายทาง: สตูล, ประเทศไทย\n"
    },
    "Songkhla": {
        "description": (
            "คุณมีหน้าที่ในการเขียนรายงานแพ็กเกจท่องเที่ยวจังหวัดสงขลา "
            "โดยจะต้องรีวิวข้อมูลที่ได้รับจากนักวิจัย (Researcher) และขยายความให้ละเอียด "
            "จัดทำแพ็กเกจแบบ 5 แพ็กเกจพร้อมไทม์ไลน์กิจกรรมในแต่ละวัน รวมถึงคำนวณงบประมาณ "
            "และแนะนำตัวเลือกที่พักให้ครบถ้วน"
        ),
        "expected_output": (
            "เขียน 5 แพ็กเกจเที่ยวสงขลาพร้อมกำหนดการแต่ละวัน "
            "บอกรายละเอียดทุกอย่างตามข้อมูลที่ Researcher หาได้ "
            "แสดงราคาคร่าว ๆ รวมไปถึงระบุชื่อที่พักที่แนะนำ"
        ),
        "goal": (
            "ค้นคว้าหาสถานที่ท่องเที่ยวและข้อมูลที่ทันสมัย (ปี 2024-2025) "
            "ในจังหวัดสงขลา ประเทศไทย "
        ),
        "person": "จำนวนคนร่วมทริป: {adults} คน\n",
        "rq": "ความต้องการเพิ่มเติม: {Rq}\n",
        "pv": "จุดหมายปลายทาง: สงขลา, ประเทศไทย\n"
    },
    "Yala": {
        "description": (
            "คุณมีหน้าที่ในการเขียนรายงานแพ็กเกจท่องเที่ยวจังหวัดยะลา "
            "โดยจะต้องรีวิวข้อมูลที่ได้รับจากนักวิจัย (Researcher) และขยายความให้ละเอียด "
            "จัดทำแพ็กเกจแบบ 5 แพ็กเกจพร้อมไทม์ไลน์กิจกรรมในแต่ละวัน รวมถึงคำนวณงบประมาณ "
            "และแนะนำตัวเลือกที่พักให้ครบถ้วน"
        ),
        "expected_output": (
            "เขียน 5 แพ็กเกจเที่ยวยะลาพร้อมกำหนดการแต่ละวัน "
            "บอกรายละเอียดทุกอย่างตามข้อมูลที่ Researcher หาได้ "
            "แสดงราคาคร่าว ๆ รวมไปถึงระบุชื่อที่พักที่แนะนำ"
        ),
        "goal": (
            "ค้นคว้าหาสถานที่ท่องเที่ยวและข้อมูลที่ทันสมัย (ปี 2024-2025) "
            "ในจังหวัดยะลา ประเทศไทย "
        ),
        "person": "จำนวนคนร่วมทริป: {adults} คน\n",
        "rq": "ความต้องการเพิ่มเติม: {Rq}\n",
        "pv": "จุดหมายปลายทาง: ยะลา, ประเทศไทย\n"
    },

}

# ----------- ข้อมูลสำหรับ Style, Cost, Day Mapping -----------
style_mapping = {
    "Natural": {
        "description": (
            "เหมาะสำหรับผู้ที่ต้องการสัมผัสธรรมชาติ เช่น ภูเขา น้ำตก ทะเล "
            "และกิจกรรมกลางแจ้งต่าง ๆ"
        )
    },
    "Cafe": {
        "description": (
            "เหมาะสำหรับผู้ชื่นชอบการนั่งชิลในคาเฟ่ "
            "มองหาจุดเช็คอินสวย ๆ ถ่ายรูป และกินอาหารเบา ๆ "
        )
    },
    "Historical": {
        "description": (
            "เหมาะสำหรับผู้สนใจประวัติศาสตร์ วัฒนธรรม "
            "และสถานที่ท่องเที่ยวเชิงประเพณี"
        )
    },
    "Extreme Activity": {
        "description": (
            "เหมาะสำหรับคนที่ชื่นชอบความตื่นเต้น ท้าทาย "
            "เช่น ปีนผา ดำน้ำ ล่องแก่ง ฯลฯ"
        )
    },
    "Any": {
        "description": "ยังไม่มีสไตล์การท่องเที่ยวเฉพาะเจาะจง สามารถปรับเปลี่ยนได้ตามความสนใจ"
    }
}

cost_mapping = {
    "Low": {
        "description": (
            "งบประมาณประหยัด เน้นการเดินทางและที่พักราคาถูก "
            "เพื่อประหยัดค่าใช้จ่าย"
        )
    },
    "Mid": {
        "description": (
            "งบประมาณปานกลาง สามารถเลือกกิจกรรมและที่พัก "
            "ที่มีคุณภาพปานกลางถึงดีในราคาที่เหมาะสม"
        )
    },
    "High": {
        "description": (
            "งบประมาณสูง เน้นท่องเที่ยวแบบสะดวกสบาย "
            "ที่พักหรูหรา และกิจกรรมระดับพรีเมียม"
        )
    },
    "Any": {
        "description": "ไม่จำกัดงบประมาณ สามารถเลือกได้ตามความต้องการ"
    }
}

day_mapping = {
    "Any": {
        "description": "ยังไม่มีการกำหนดจำนวนวันที่แน่นอน ปรับเปลี่ยนตามความยืดหยุ่น"
    },
    "1": {
        "description": "ทริปสั้น ๆ 1 วัน เดินทางเช้า-เย็นกลับ"
    },
    "2": {
        "description": "ทริป 2 วัน 1 คืน เหมาะสำหรับท่องเที่ยวพักผ่อนช่วงสุดสัปดาห์"
    },
    "3": {
        "description": "ทริป 3 วัน 2 คืน เหมาะกับการท่องเที่ยวหลายจุดหมาย"
    },
    "4": {
        "description": "ทริป 4 วัน 3 คืน มีเวลาเที่ยวอย่างเต็มอิ่ม"
    },
    "5": {
        "description": "ทริป 5 วัน 4 คืน สำหรับผู้ต้องการเจาะลึกสถานที่ท่องเที่ยว"
    },
    "6": {
        "description": "ทริป 6 วัน 5 คืน เหมาะกับการเที่ยวแบบรอบด้าน"
    },
    "7": {
        "description": "ทริป 7 วัน 6 คืน เที่ยวได้หลากหลายจังหวัดหรือหลายจุด"
    },
    "more7": {
        "description": (
            "ทริปที่นานกว่า 7 วัน เหมาะกับการท่องเที่ยวเชิงลึก "
            "พักยาวหรือหลายพื้นที่"
        )
    },
}


@app.post("/set_task")
async def set_task(request: TaskRequest):
    """
    รับ Task จาก Frontend → สร้าง CrewAI workflow → ส่งผลลัพธ์กลับ
    โดยจะมี 2 Agent ได้แก่ Researcher และ Writer
    """

    # ตรวจสอบ task_type (จังหวัด) ที่ผู้ใช้ส่งมา
    task_info = task_mapping.get(request.task_type)
    if not task_info:
        raise HTTPException(status_code=400, detail="Invalid task type")

    # ตรวจสอบ style, cost, day
    style_info = style_mapping.get(request.style)
    if not style_info:
        raise HTTPException(status_code=400, detail="Invalid style option")

    cost_info = cost_mapping.get(request.cost)
    if not cost_info:
        raise HTTPException(status_code=400, detail="Invalid cost option")

    day_info = day_mapping.get(request.day)
    if not day_info:
        raise HTTPException(status_code=400, detail="Invalid day option")

    # ----------- สร้าง Agent นักวิจัยข้อมูล (Researcher) -----------
    researcher = Agent(
        role="Thai Tour Researcher",
        goal=(
            # goal จาก task_mapping + จำนวนคน + ความต้องการเพิ่มเติม
            task_info["goal"]
            + task_info["person"].format(adults=request.adults)
            + task_info["rq"].format(Rq=request.Rq)
        ),
        backstory=(
            "คุณคือผู้เชี่ยวชาญด้านการวิจัยข้อมูลท่องเที่ยวในภาคใต้ของไทย "
            "มีประสบการณ์ในเส้นทางท่องเที่ยวทุกจังหวัดในภาคใต้ "
            "และสามารถหาแหล่งข้อมูลล่าสุดปี 2024-2025 ได้อย่างละเอียด"
        ),
        tools=[search_tools],  # ให้ Researcher ใช้เครื่องมือ search
        verbose=True
    )

    # ----------- สร้าง Agent คนเขียนแพ็กเกจทัวร์ (Writer) -----------
    writer = Agent(
        role="Trip Planner",
        goal=(
            "รวบรวมข้อมูลจากนักวิจัยและเขียนแพ็กเกจทัวร์จำนวน 5 แพ็กเกจ "
            "พร้อมกำหนดการและรายละเอียดทั้งหมด "
            + task_info["pv"]
        ),
        backstory=(
            "คุณเป็นผู้เชี่ยวชาญในการวางแผนทัวร์ในภาคใต้ของไทย "
            "สามารถสร้างแพ็กเกจทัวร์ที่น่าสนใจ มีรายละเอียดครบถ้วน "
            "และนำข้อมูลจากนักวิจัยมาใช้ได้อย่างเต็มที่"
        ),
        verbose=True
    )

    # ----------- สร้าง Task 1: ให้ Researcher ค้นหาข้อมูล -----------
    research_task = Task(
        agent=researcher,
        description=(
            "ทำการค้นคว้าข้อมูลแหล่งท่องเที่ยวที่ได้รับความนิยม "
            "ตั้งแต่ปี 2024 ถึงปัจจุบัน 2025 ใน "
            + task_info["pv"]
            + "รวมถึงกิจกรรม อาหารแนะนำ ชื่อที่พัก และค่าใช้จ่ายตามงบประมาณ "
            "โดยคำนึงถึงสไตล์การเที่ยวที่ผู้ใช้เลือก ("
            + request.style
            + ")"
        ),
        expected_output=(
            "ข้อมูลแหล่งท่องเที่ยว รายละเอียดประวัติความเป็นมา "
            "กิจกรรม ราคา ที่พัก (พร้อมชื่อของที่พัก) อาหาร และการเดินทาง "
            "สอดคล้องกับงบประมาณ: " + request.cost + " และระยะเวลา: " + request.day + " วัน"
        ),
        tools=[search_tools]
    )

    # ----------- สร้าง Task 2: ให้ Writer เขียนแพ็กเกจทัวร์ -----------
    writer_task = Task(
        agent=writer,
        description=task_info["description"],     # ใช้ description จาก task_mapping
        expected_output=task_info["expected_output"],  # ใช้ expected_output จาก task_mapping
        context=[research_task]  # ดึงเอาผลลัพธ์จาก Researcher มาใช้
    )

    # ----------- สร้าง Crew และเรียกใช้งานแบบ Sequential -----------
    crew = Crew(
        agents=[researcher, writer],
        tasks=[research_task, writer_task],
        process=Process.sequential
    )

    # เริ่มต้นทำงาน
    result = crew.kickoff()
    html_result = markdown.markdown(str(result))

    return {
        "message": "Task completed!",
        "result": str(html_result)
    }
